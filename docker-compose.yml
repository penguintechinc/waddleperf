version: '3.8'

services:
  # MariaDB Galera Cluster (Single-node for dev, multi-node for prod)
  mariadb:
    image: mariadb:11.2
    container_name: waddleperf-mariadb
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-dev_root_password}
      MYSQL_DATABASE: ${DB_NAME:-waddleperf}
      MYSQL_USER: ${DB_USER:-waddleperf}
      MYSQL_PASSWORD: ${DB_PASS:-dev_password}
    ports:
      - "3306:3306"
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./database/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
      - ./database/seeds/01_dev_data.sql:/docker-entrypoint-initdb.d/02-dev_data.sql:ro
      - ./database/03_add_config_and_tokens.sql:/docker-entrypoint-initdb.d/03-config-tokens.sql:ro
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - waddleperf-network

  # testServer (Go) - High-performance test execution server
  testserver:
    build:
      context: ./testServer
      dockerfile: Dockerfile
    container_name: waddleperf-testserver
    cap_add:
      - NET_RAW
      - NET_ADMIN
    environment:
      MANAGER_KEY: ${MANAGER_KEY:-0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef}
      MANAGER_URL: grpc://unified-api:50051
      DB_HOST: mariadb
      DB_PORT: 3306
      DB_USER: ${DB_USER:-waddleperf}
      DB_PASS: ${DB_PASS:-dev_password}
      DB_NAME: ${DB_NAME:-waddleperf}
      AUTH_ENABLED: ${AUTH_ENABLED:-true}
      LOG_LEVEL: ${LOG_LEVEL:-debug}
      MAX_CONCURRENT_TESTS: 100
      PORT: 8080
    ports:
      - "8080:8080"
    depends_on:
      mariadb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - waddleperf-network
    restart: unless-stopped

  # Unified API (Flask/Quart) - Combined management and web client backend
  unified-api:
    build:
      context: ./services/unified-api
      dockerfile: Dockerfile
    container_name: waddleperf-unified-api
    environment:
      MANAGER_KEY: ${MANAGER_KEY:-0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef}
      SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-in-production}
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-change-in-production}
      DB_TYPE: ${DB_TYPE:-mysql}
      DB_HOST: mariadb
      DB_PORT: 3306
      DB_USER: ${DB_USER:-waddleperf}
      DB_PASS: ${DB_PASS:-dev_password}
      DB_NAME: ${DB_NAME:-waddleperf}
      MFA_REQUIRED: ${MFA_REQUIRED:-false}
      FLASK_ENV: development
      FLASK_DEBUG: 1
      LOG_LEVEL: debug
      PORT: 5000
    ports:
      - "5000:5000"
      - "50051:50051"  # gRPC port
    depends_on:
      mariadb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - waddleperf-network
    restart: unless-stopped

  # managerServer Frontend (React) - Management UI
  managerserver-frontend:
    build:
      context: ./managerServer/frontend
      dockerfile: Dockerfile.frontend
    container_name: waddleperf-manager-frontend
    environment:
      VITE_API_URL: http://localhost:5000
      NODE_ENV: development
    ports:
      - "3000:80"
    volumes:
      - ./managerServer/frontend/src:/app/src:ro
      - ./managerServer/frontend/public:/app/public:ro
    depends_on:
      - unified-api
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 15s
    networks:
      - waddleperf-network
    restart: unless-stopped


  # webClient Frontend (React) - Browser-based test client UI
  webclient-frontend:
    build:
      context: ./webClient
      dockerfile: Dockerfile.frontend
    container_name: waddleperf-webclient-frontend
    environment:
      VITE_API_URL: http://localhost:5000
      VITE_WS_URL: ws://localhost:5000
      VITE_TESTSERVER_URL: http://localhost:8080
      NODE_ENV: development
    ports:
      - "3001:80"
    volumes:
      - ./webClient/frontend/src:/app/src:ro
      - ./webClient/frontend/public:/app/public:ro
    depends_on:
      - unified-api
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 15s
    networks:
      - waddleperf-network
    restart: unless-stopped

  # containerClient (Python) - Automated testing container
  containerclient:
    build:
      context: ./containerClient
      dockerfile: Dockerfile
    container_name: waddleperf-containerclient
    cap_add:
      - NET_RAW
      - NET_ADMIN
    environment:
      AUTH_TYPE: ${AUTH_TYPE:-apikey}
      AUTH_APIKEY: ${AUTH_APIKEY:-test-api-key}
      MANAGER_URL: http://unified-api:5000
      TEST_SERVER_URL: http://testserver:8080
      RUN_SECONDS: ${RUN_SECONDS:-0}  # 0 = manual only in dev
      ENABLE_HTTP_TEST: "true"
      ENABLE_TCP_TEST: "true"
      ENABLE_UDP_TEST: "true"
      ENABLE_ICMP_TEST: "true"
      DEVICE_SERIAL: dev-container-001
      DEVICE_HOSTNAME: containerclient-dev
    depends_on:
      - testserver
      - unified-api
    networks:
      - waddleperf-network
    restart: "no"  # Manual execution in dev

  # Adminer (Database Management UI)
  adminer:
    image: adminer:4.8.1
    container_name: waddleperf-adminer
    ports:
      - "8081:8080"
    environment:
      ADMINER_DEFAULT_SERVER: mariadb
      ADMINER_DESIGN: pepa-linha
    depends_on:
      - mariadb
    networks:
      - waddleperf-network
    restart: unless-stopped

networks:
  waddleperf-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  mariadb_data:
    driver: local
